{% extends "base.html" %}
{% block content %}

<h2>График: Время выполнения батчей</h2>
<canvas id="timeChart" width="800" height="400"></canvas>

<!-- Данные из FastAPI -->
<div id="chart-container" data-batch-info='{{ info | tojson }}'></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById('chart-container');
    if (!container) {
      console.error("Контейнер не найден");
      return;
    }

    let info;
    try {
      info = JSON.parse(container.dataset.batchInfo);
    } catch (e) {
      console.error("Ошибка парсинга JSON:", e);
      return;
    }

    if (!info || info.length === 0) {
      console.warn("Нет данных для отображения");
      return;
    }

    // --- Подготовка данных ---
    // Преобразуем batch_time в объект Date с фиксированной датой (например, 1970-01-01)
    // Это нужно, чтобы Chart.js понимал время
    const data = info.map(item => {
      const [hours, minutes] = item.batch_time.split(":");
      const date = new Date(1970, 0, 1, parseInt(hours), parseInt(minutes)); // 1970-01-01 HH:MM
      return {
        x: item.batch_date,           // дата по оси X
        y: date                       // время по оси Y
      };
    });

    // --- Настройка графика ---
    const ctx = document.getElementById('timeChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'Время выполнения батча',
            data: data,
            borderColor: 'rgb(75, 140, 220)',
            backgroundColor: 'rgba(75, 140, 220, 0.2)',
            pointRadius: 6,
            tension: 0.2
          }
        ]
      },
      options: {
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const d = context.parsed;
                const date = new Date(d.y);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `Время: ${hours}:${minutes}`;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day',
              displayFormats: { day: 'dd.MM.yyyy' },
              tooltipFormat: 'PP'
            },
            title: {
              display: true,
              text: 'Дата'
            }
          },
          y: {
            type: 'time',
            time: {
              unit: 'minute',
              displayFormats: { minute: 'HH:mm' }
            },
            title: {
              display: true,
              text: 'Время суток'
            },
            min: new Date(1970, 0, 1, 0, 0), // 3:40
            max: new Date(1970, 0, 1, 23, 59), // 6:20
            ticks: {
              stepSize: 20, // каждые 20 минут
              callback: function(value) {
                const date = new Date(value);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
              }
            }
          }
        }
      }
    });
  });
</script>

{% endblock %}
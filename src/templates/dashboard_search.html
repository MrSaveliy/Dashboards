{% extends "dashboard_dfo.html" %}
{% block content %}
<h2>Время выполнения батча ДФО</h2>
<canvas id="timeChart" width="00" height="400"></canvas>

<!-- Данные из FastAPI -->
<div id="chart-container" data-batch-info='{{ info | tojson }}'></div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById('chart-container');
    if (!container) {
      console.error("Контейнер не найден");
      return;
    }

    let info;
    try {
      info = JSON.parse(container.dataset.batchInfo);
    } catch (e) {
      console.error("Ошибка парсинга JSON:", e);
      return;
    }

    if (!info || info.length === 0) {
      console.warn("Нет данных для отображения");
      return;
    }

    // --- Подготовка данных ---
    const data = info.map(item => {
      const [hours, minutes] = item.batch_time.split(":");
      const date = new Date(1970, 0, 1, parseInt(hours), parseInt(minutes));
      return {
        x: item.batch_date,
        y: date
      };
    });

    // Порог: 5:00 утра
    const thresholdTime = new Date(1970, 0, 1, 5, 0); // 5:00

    // --- Настройка графика ---
    const ctx = document.getElementById('timeChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'Время выполнения батча',
            data: data,
            borderColor: 'rgb(75, 140, 220)',
            backgroundColor: 'rgba(75, 140, 220, 0.2)',
            pointRadius: 6,
            tension: 0.2

          }
        ]
      },
      options: {
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const d = context.parsed;
                const date = new Date(d.y);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `Время: ${hours}:${minutes}`;
              }
            }
          },
          annotation: {
            annotations: {
              // Горизонтальная линия на 5:00
              line1: {
                type: 'line',
                yMin: thresholdTime,
                yMax: thresholdTime,
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 2,
                label: {
                  content: 'Порог: 5:00',
                  enabled: false,
                  position: 'start'
                }
              },
              // Заливка области ВЫШЕ порога (позднее выполнение)
              box1: {
                type: 'box',
                yMin: new Date(1970, 0, 1, 3, 0), // начало диапазона (например, 3:00),
                yMax: thresholdTime, // до 7:00
                backgroundColor: 'rgba(255, 99, 132, 0.15)',
                borderColor: 'transparent'
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day',
              displayFormats: { day: 'dd.MM.yyyy' },
              tooltipFormat: 'PP'
            },
            title: {
              display: true,
              text: 'Дата'
            }
          },
          y: {
            type: 'time',
            time: {
              unit: 'minute',
              displayFormats: { minute: 'HH:mm' }
            },
            title: {
              display: true,
              text: 'Время суток'
            },
            min: new Date(1970, 0, 1, 3, 0), // 3:00
            max: new Date(1970, 0, 1, 7, 0), // 7:00
            ticks: {
              stepSize: 20,
              callback: function(value) {
                const date = new Date(value);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
              }
            }
          }
        }
      }
    });
  });
</script>

{% endblock %}